<html>
   <head>
      <title>Box2dWeb Demo</title>
      <style type="text/css">
      	body {
      		overflow: hidden;
      		margin: 0px;
      		
      	}
      </style>
   </head>
   <body>
   </body>
   <script type="text/javascript" src="js/Box2dWeb-2.1.a.3.min.js"></script>
   <script type="text/javascript" src="js/Three.js"></script>
   <script type="text/javascript" src="js/Stats.js"></script>
   <script type="text/javascript">
   
   var   b2Vec2 = Box2D.Common.Math.b2Vec2
   ,  b2AABB = Box2D.Collision.b2AABB
	,	b2BodyDef = Box2D.Dynamics.b2BodyDef
	,	b2Body = Box2D.Dynamics.b2Body
	,	b2FixtureDef = Box2D.Dynamics.b2FixtureDef
	,	b2Fixture = Box2D.Dynamics.b2Fixture
	,	b2World = Box2D.Dynamics.b2World
	,	b2MassData = Box2D.Collision.Shapes.b2MassData
	,	b2PolygonShape = Box2D.Collision.Shapes.b2PolygonShape
	,	b2CircleShape = Box2D.Collision.Shapes.b2CircleShape
	,	b2DebugDraw = Box2D.Dynamics.b2DebugDraw
   ,   b2MouseJointDef =  Box2D.Dynamics.Joints.b2MouseJointDef
   ,   b2DistanceJointDef = Box2D.Dynamics.Joints.b2DistanceJointDef
   ,   b2RevoluteJointDef = Box2D.Dynamics.Joints.b2RevoluteJointDef
   ;
	   
	   var camera, scene, renderer, stats,
	   geometry, material, mesh;
	   
       var mouseX, mouseY, mousePVec, isMouseDown, selectedBody, mouseJoint;
       var world;
       
       var fixDef = new b2FixtureDef;
       fixDef.density = 1.0;
       fixDef.friction = 0.3;
       fixDef.restitution = 0.2;
       
       var bodyDef = new b2BodyDef;
	
	   var boingies = new Array();
	
	   function animate() {
	       requestAnimationFrame( animate );
	       render();
	   }
	
	   function render() {
	
		   if(isMouseDown && (!mouseJoint)) {
               var body = getBodyAtMouse(0.1);
               if(body) {
                  var md = new b2MouseJointDef();
                  md.bodyA = world.GetGroundBody();
                  md.bodyB = body;
                  md.target.Set(mouseX, mouseY);
                  md.collideConnected = true;
                  md.maxForce = 2800.0 * body.GetMass();
                  mouseJoint = world.CreateJoint(md);
                  body.SetAwake(true);
               } else {
            	   var bs = 7;
            	   var hbs = bs/2;
            	   if(!getBodyAtMouse(hbs)) {
	            	   var v = new b2Vec2(mouseX, mouseY)
	            	   if(v.x > hbs && v.y > hbs && v.x < window.innerWidth / 30 - hbs && v.y < window.innerHeight / 30 - hbs)
	            	   createBoingy(v.x-hbs,v.y-hbs,bs,bs);
            	   }	
               }
            }
            
            if(mouseJoint) {
               if(isMouseDown) {
                  mouseJoint.SetTarget(new b2Vec2(mouseX, mouseY));
               } else {
                  world.DestroyJoint(mouseJoint);
                  mouseJoint = null;
               }
            }
         
            world.Step(1 / 60, 10, 10);
            world.ClearForces();
            
            updateBoingeGeo();
            
	       renderer.render( scene, camera );
	       stats.update();
	
	   }
	   
	   function updateBoingeGeo() {
		   for(var a in boingies) {
			   var bb = boingies[a];
			   var vs = bb.mesh.geometry.vertices;
			   
			   var i,b,wc,dx,dy,xl,yl,cc,xm,ym;
			   xl = bb.bodies.length;
			   yl = bb.bodies[0].length;
			   cc = bb.bodies[Math.floor(xl/2)][Math.floor(yl/2)].GetPosition();
			   xm = 1/xl;
			   ym = 1/yl;
			   for(var x = 0; x < xl; ++x) {
				    
				    
		         	for(var y = 0; y < yl; ++y) {
		         		i = xl*y+x;
		         		b = bb.bodies[x][y];
		         		wc = b.GetPosition();
		         		vs[i].x = (wc.x+(wc.x-cc.x)*xm)*30;
						vs[i].z = (wc.y+(wc.y-cc.y)*ym)*30;
		         	}
				}

			   bb.mesh.geometry.verticesNeedUpdate = true;
		   }
	   }
	   
	   document.addEventListener("mousedown", function(e) {
           isMouseDown = true;
           handleMouseMove(e);
           document.addEventListener("mousemove", handleMouseMove, true);
        }, true);
        
        document.addEventListener("mouseup", function() {
           document.removeEventListener("mousemove", handleMouseMove, true);
           isMouseDown = false;
           mouseX = undefined;
           mouseY = undefined;
        }, true);
        
        function handleMouseMove(e) {
           mouseX = e.clientX / 30;
           mouseY = e.clientY / 30;
        };
        
        function getBodyAtMouse(ss) {
           mousePVec = new b2Vec2(mouseX, mouseY);
           var aabb = new b2AABB();
           aabb.lowerBound.Set(mouseX - ss, mouseY - ss);
           aabb.upperBound.Set(mouseX + ss, mouseY + ss);
           
           selectedBody = null;
           world.QueryAABB(getBodyCB, aabb);
           return selectedBody;
        }

        function getBodyCB(fixture) {
           if(fixture.GetBody().GetType() != b2Body.b2_staticBody) {
                selectedBody = fixture.GetBody();
                return false;
           }
           return true;
        }
        
        function createBoingy(xx, yy, bSizeX, bSizeY) {
       	 fixDef.filter.groupIndex = 1;
	         var bodies = new Array();
	         bodyDef.type = b2Body.b2_dynamicBody;
	         for(var x = 0; x < bSizeX; ++x) {
	        	bodies.push(new Array());
	        	for(var y = 0; y < bSizeY; ++y) {
	        		
		            fixDef.shape = new b2PolygonShape;
		            fixDef.shape.SetAsBox(0.3, 0.3);
		            bodyDef.position.x = x+xx;
		            bodyDef.position.y = y+yy;
		            bodyDef.fixedRotation = true;
		            var body = world.CreateBody(bodyDef);
		            body.CreateFixture(fixDef);
		            bodies[x][y] = body;
	        	}
	         }
	         
	         function createSpringJoint(b1, b2, collide) {
	        	var j = new b2DistanceJointDef();
	      		j.Initialize(b1, b2, b1.GetWorldCenter(), b2.GetWorldCenter());
	      		j.collideConnected = collide;
	      		j.frequencyHz = 10.0;
	      		j.dampingRatio = 0.2;
	      		world.CreateJoint(j);
	         }; 
	         
	         for(var x = 0; x < bSizeX; ++x) {
	         	for(var y = 0; y < bSizeY; ++y) {
	         		var cc = (x > 0 && x < bSizeX - 1 && y > 0 && y < bSizeY - 1);
	         		if(x < bSizeX - 1 && y < bSizeY - 1) {
		         		createSpringJoint(bodies[x][y], bodies[x+1][y], cc); 
		         		createSpringJoint(bodies[x][y], bodies[x][y+1], cc);
		         		createSpringJoint(bodies[x][y], bodies[x+1][y+1], cc);
	         		}
	         		if(x > 0 && y < bSizeY - 1) {
	         			createSpringJoint(bodies[x][y], bodies[x-1][y+1], cc);
	         		}
	         		if (x == bSizeX - 1 && y < bSizeY - 1) {
	         			createSpringJoint(bodies[x][y], bodies[x][y+1], cc);
	         		} 
	         		if (x < bSizeX - 1 && y == bSizeY - 1) {
	         			createSpringJoint(bodies[x][y], bodies[x+1][y], cc);
	         		}
	         	}
	         }
	         fixDef.filter.groupIndex = -1;
	         for(var yp = 0; yp < bSizeY; yp += bSizeY-1) {
		         for(var x = 0; x < bSizeX-1; ++x) {
		        	fixDef.shape = new b2PolygonShape;
		            fixDef.shape.SetAsBox(0.5,0.35);
		            bodyDef.position.x = x+xx+0.5;
		            bodyDef.position.y = yy+yp;
		            bodyDef.fixedRotation = false;
		            var body = world.CreateBody(bodyDef);
		            body.CreateFixture(fixDef);
		            var j = new b2RevoluteJointDef();
		      		j.Initialize(body, bodies[x+1][yp], bodies[x+1][yp].GetWorldCenter());
		      		j.collideConnected = false;
		      		j.frequencyHz = 6.0;
		      		j.dampingRatio = 0.2;
		      		world.CreateJoint(j);
		      		var j = new b2RevoluteJointDef();
		            j.Initialize(body, bodies[x][yp], bodies[x][yp].GetWorldCenter());
		      		j.collideConnected = false;
		      		j.frequencyHz = 6.0;
		      		j.dampingRatio = 0.2;
		      		world.CreateJoint(j);
		         }
	         }
	         for(var xp = 0; xp < bSizeX; xp += bSizeX-1) {
		         for(var y = 0; y < bSizeY-1; ++y) {
		        	fixDef.shape = new b2PolygonShape;
		            fixDef.shape.SetAsBox(0.35,0.5);
		            bodyDef.position.x = xx+xp;
		            bodyDef.position.y = yy+y+0.5;
		            bodyDef.fixedRotation = false;
		            var body = world.CreateBody(bodyDef);
		            body.CreateFixture(fixDef);
		            var j = new b2RevoluteJointDef();
		      		j.Initialize(body, bodies[xp][y+1], bodies[xp][y+1].GetWorldCenter());
		      		j.collideConnected = false;
		      		world.CreateJoint(j);
		      		var j = new b2RevoluteJointDef();
		            j.Initialize(body, bodies[xp][y], bodies[xp][y].GetWorldCenter());
		      		j.collideConnected = false;
		      		world.CreateJoint(j);
		         }
	         }
	         
	         var geo = new THREE.PlaneGeometry(bSizeX*30,bSizeY*30,bSizeX-1,bSizeY-1);
	         geo.dynamic = true;
	         mesh = new THREE.Mesh(geo , material );
	         mesh.rotation.x = Math.PI/2;
	         scene.add( mesh );
	     	 boingies.push({mesh: mesh, bodies: bodies})    
        }
      
        window.onload = function() {
    	  
    	  scene = new THREE.Scene();
    		
    	  camera = new THREE.OrthographicCamera( 0, window.innerWidth , 0, -window.innerHeight, -1000, 1000 );
	  		camera.position.x = 0;
	  		camera.position.y = 0;
	  		camera.position.z = 1;
	       scene.add( camera );
	
	       //material = new THREE.MeshBasicMaterial( { color: 0xff0000, wireframe: true, wireframeLinewidth: 3 } );
	       material = new THREE.MeshLambertMaterial({ map: THREE.ImageUtils.loadTexture("crate.jpg") });
	
	        scene.add(new THREE.AmbientLight(0xFFFFFF));
	        
	       renderer = new THREE.WebGLRenderer({
	    	   antialias: true
	       });
	       renderer.setSize( window.innerWidth, window.innerHeight );
	
	       document.body.appendChild( renderer.domElement );
         
         world = new b2World(
               new b2Vec2(0, 8)    //gravity
            ,  true                 //allow sleep
         );
         
         stats = new Stats();
     	stats.domElement.style.position = 'absolute';
     	stats.domElement.style.top = '0px';
     	document.body.appendChild( stats.domElement );
         
         //create ground
         bodyDef.type = b2Body.b2_staticBody;
         fixDef.shape = new b2PolygonShape;
         fixDef.shape.SetAsBox(window.innerWidth / 30, 2);
         bodyDef.position.Set(0, window.innerHeight / 30 + 2);
         world.CreateBody(bodyDef).CreateFixture(fixDef);
         bodyDef.position.Set(0, -2.1);
         world.CreateBody(bodyDef).CreateFixture(fixDef);
         fixDef.shape.SetAsBox(2, window.innerHeight / 30);
         bodyDef.position.Set(-2.1, 0);
         world.CreateBody(bodyDef).CreateFixture(fixDef);
         bodyDef.position.Set(window.innerWidth / 30+2.1, 0);
         world.CreateBody(bodyDef).CreateFixture(fixDef);

         createBoingy(window.innerWidth / 60-3.5,window.innerHeight / 30-15,7,7);
         
         var textureImg = new Image();
         textureImg.onload = function(){
             animate();
         };
         textureImg.src = "crate.jpg";
         


         
      };
      
      
   
   </script>
   
   
</html>