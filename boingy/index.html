<!DOCTYPE HTML>
<html>
   <head>
   	  <meta charset="utf-8" />
      <title>Boingy</title>
      <style type="text/css">
      	body {
      		overflow: hidden;
      		margin: 0px;
      	}
      </style>
   </head>
   <body>
   	 <canvas id="canvas" style="background-color:#333333; display:none;" ></canvas>
   </body>
   <script type="text/javascript" src="js/Box2dWeb-2.1.a.3.min.js"></script>
   <script type="text/javascript" src="js/Three.js"></script>
   <script type="text/javascript" src="js/Stats.js"></script>
   <script type="text/javascript">
   
   var debug = false;
   
   var   b2Vec2 = Box2D.Common.Math.b2Vec2
   ,  b2AABB = Box2D.Collision.b2AABB
	,	b2BodyDef = Box2D.Dynamics.b2BodyDef
	,	b2Body = Box2D.Dynamics.b2Body
	,	b2FixtureDef = Box2D.Dynamics.b2FixtureDef
	,	b2Fixture = Box2D.Dynamics.b2Fixture
	,	b2World = Box2D.Dynamics.b2World
	,	b2MassData = Box2D.Collision.Shapes.b2MassData
	,	b2PolygonShape = Box2D.Collision.Shapes.b2PolygonShape	
   ,   b2MouseJointDef =  Box2D.Dynamics.Joints.b2MouseJointDef
   ,	b2DebugDraw = Box2D.Dynamics.b2DebugDraw
   ,   b2DistanceJointDef = Box2D.Dynamics.Joints.b2DistanceJointDef
   ;
	   
	   var camera, scene, renderer, stats,
	   geometry, material, mesh;
	   
       var mouseX, mouseY, mousePVec, isMouseDown, selectedBody, mouseJoint;
       var world;
       
       var wallt, wallb, walll, wallr;
       
       var fixDef = new b2FixtureDef;
       fixDef.density = 1.0;
       fixDef.friction = 0.5;
       fixDef.restitution = 0.0;
       
       var bodyDef = new b2BodyDef;
	
	   var boingies = new Array();
	
	   function animate() {
	       requestAnimationFrame( animate );
	       render();
	   }
	
	   function render() {
	
		   if(isMouseDown && (!mouseJoint)) {
               var body = getBodyAtMouse(0.1);
               if(body) {
                  var md = new b2MouseJointDef();
                  md.bodyA = world.GetGroundBody();
                  md.bodyB = body;
                  md.target.Set(mouseX, mouseY);
                  md.collideConnected = true;
                  md.maxForce = 800.0 * body.GetMass();
                  mouseJoint = world.CreateJoint(md);
                  body.SetAwake(true);
               } else {
            	   var bs = 5;
            	   var hbs = bs/2;
            	   if(!getBodyAtMouse(hbs)) {
	            	   var v = new b2Vec2(mouseX, mouseY)
	            	   if(v.x > hbs && v.y > hbs && v.x < window.innerWidth / 30 - hbs && v.y < window.innerHeight / 30 - hbs)
	            	   createBoingy(v.x-hbs,v.y-hbs,bs,bs);
            	   }	
               }
            }
            
            if(mouseJoint) {
               if(isMouseDown) {
                  mouseJoint.SetTarget(new b2Vec2(mouseX, mouseY));
               } else {
                  world.DestroyJoint(mouseJoint);
                  mouseJoint = null;
               }
            }
         
            world.Step(1 / 60, 10, 10);
            if(debug) {
            	world.DrawDebugData();
            } else {
               updateBoingeGeo();
     	       renderer.render( scene, camera );
            }
   		    stats.update();
            world.ClearForces();
            
	
	   }
	   
	   function updateBoingeGeo() {
		   for(var a in boingies) {
			   var bb = boingies[a];
			   var vs = bb.mesh.geometry.vertices;
			   
			   var i,b,wc,dx,dy,xl,yl,cc,xm,ym;
			   xl = bb.bodies.length;
			   yl = bb.bodies[0].length;
			   cc = bb.bodies[Math.floor(xl/2)][Math.floor(yl/2)].GetPosition();
			   xm = (1/xl)*0.8;
			   ym = (1/yl)*0.8;
			   for(var x = 0; x < xl; ++x) {
				    
				    
		         	for(var y = 0; y < yl; ++y) {
		         		i = xl*y+x;
		         		b = bb.bodies[x][y];
		         		wc = b.GetPosition();
		         		vs[i].x = (wc.x+(wc.x-cc.x)*xm)*30;
						vs[i].z = (wc.y+(wc.y-cc.y)*ym)*30;
		         	}
				}

			   bb.mesh.geometry.verticesNeedUpdate = true;
		   }
	   }
	   
	   document.addEventListener("mousedown", function(e) {
           isMouseDown = true;
           handleMouseMove(e);
           document.addEventListener("mousemove", handleMouseMove, true);
        }, true);
        
        document.addEventListener("mouseup", function() {
           document.removeEventListener("mousemove", handleMouseMove, true);
           isMouseDown = false;
           mouseX = undefined;
           mouseY = undefined;
        }, true);
        
        function handleMouseMove(e) {
           mouseX = e.clientX / 30;
           mouseY = e.clientY / 30;
        };
        
        function getBodyAtMouse(ss) {
           mousePVec = new b2Vec2(mouseX, mouseY);
           var aabb = new b2AABB();
           aabb.lowerBound.Set(mouseX - ss, mouseY - ss);
           aabb.upperBound.Set(mouseX + ss, mouseY + ss);
           
           selectedBody = null;
           world.QueryAABB(getBodyCB, aabb);
           return selectedBody;
        }

        function getBodyCB(fixture) {
           if(fixture.GetBody().GetType() != b2Body.b2_staticBody) {
                selectedBody = fixture.GetBody();
                return false;
           }
           return true;
        }
        
        function createBoingy(xx, yy, bSizeX, bSizeY) {
       	 fixDef.filter.groupIndex = 1;
	         var bodies = new Array();
	         bodyDef.type = b2Body.b2_dynamicBody;
	         for(var x = 0; x < bSizeX; ++x) {
	        	bodies.push(new Array());
	        	for(var y = 0; y < bSizeY; ++y) {
	        		
		            fixDef.shape = new b2PolygonShape;
		            fixDef.shape.SetAsBox(0.3, 0.3);
		            bodyDef.position.x = x+xx;
		            bodyDef.position.y = y+yy;
		            bodyDef.fixedRotation = true;
		            var body = world.CreateBody(bodyDef);
		            body.CreateFixture(fixDef);
		            bodies[x][y] = body;
	        	}
	         }
	         
	         function createSpringJoint(b1, b2, collide) {
	        	var j = new b2DistanceJointDef();
	      		j.Initialize(b1, b2, b1.GetWorldCenter(), b2.GetWorldCenter());
	      		j.collideConnected = collide;
	      		j.frequencyHz = 7.0;
	      		j.dampingRatio = 0.2;
	      		world.CreateJoint(j);
	         }; 
	         
	         for(var x = 0; x < bSizeX; ++x) {
	         	for(var y = 0; y < bSizeY; ++y) {
	         		var cc = true;//(x > 0 && x < bSizeX - 1 && y > 0 && y < bSizeY - 1);
	         		if(x < bSizeX - 1 && y < bSizeY - 1) {
		         		createSpringJoint(bodies[x][y], bodies[x+1][y], cc); 
		         		createSpringJoint(bodies[x][y], bodies[x][y+1], cc);
		         		createSpringJoint(bodies[x][y], bodies[x+1][y+1], cc);
	         		}
	         		if(x > 0 && y < bSizeY - 1) {
	         			createSpringJoint(bodies[x][y], bodies[x-1][y+1], cc);
	         		}
	         		if (x == bSizeX - 1 && y < bSizeY - 1) {
	         			createSpringJoint(bodies[x][y], bodies[x][y+1], cc);
	         		} 
	         		if (x < bSizeX - 1 && y == bSizeY - 1) {
	         			createSpringJoint(bodies[x][y], bodies[x+1][y], cc);
	         		}
	         	}
	         }
	         
	         var geo = new THREE.PlaneGeometry(bSizeX*30,bSizeY*30,bSizeX-1,bSizeY-1);
	         geo.dynamic = true;
	         mesh = new THREE.Mesh(geo , material );
	         mesh.rotation.x = Math.PI/2;
	         mesh.position.z = boingies	.length;
	         scene.add( mesh );
	     	 boingies.push({mesh: mesh, bodies: bodies})    
        }
        
    	window.addEventListener('resize', function(){
    		renderer.setSize( window.innerWidth, window.innerHeight );
    		camera.right = window.innerWidth;
    		camera.bottom = -window.innerHeight;
    		camera.updateProjectionMatrix();
    		
    		wallb.SetPosition(new b2Vec2(0, window.innerHeight / 30 + 2));
    		wallr.SetPosition(new b2Vec2(window.innerWidth / 30+2.1, 0));
    	}, false);
      
        window.onload = function() {
    	  
    	  scene = new THREE.Scene();
    		
    	  camera = new THREE.OrthographicCamera( 0, window.innerWidth , 0, -window.innerHeight, -1000, 1000 );
	  		camera.position.x = 0;
	  		camera.position.y = 0;
	  		camera.position.z = 1;
	       scene.add( camera );
	
	       //material = new THREE.MeshBasicMaterial( { color: 0xff0000, wireframe: true, wireframeLinewidth: 3 } );
	       material = new THREE.MeshLambertMaterial({ map: THREE.ImageUtils.loadTexture("crate.jpg") });
	
	        scene.add(new THREE.AmbientLight(0xFFFFFF));
	        
	       renderer = new THREE.WebGLRenderer({
	    	   antialias: true
	       });
	       renderer.setSize( window.innerWidth, window.innerHeight );
	
	       document.body.appendChild( renderer.domElement );
         
         world = new b2World( new b2Vec2(0, 10), true );
         
         stats = new Stats();
     	stats.domElement.style.position = 'absolute';
     	stats.domElement.style.top = '0px';
     	document.body.appendChild( stats.domElement );
         
         //create ground
         bodyDef.type = b2Body.b2_staticBody;
         fixDef.shape = new b2PolygonShape;
         fixDef.shape.SetAsBox(100, 2);
         
         bodyDef.position.Set(0, window.innerHeight / 30 + 2);
         wallb = world.CreateBody(bodyDef);
         wallb.CreateFixture(fixDef);
         
         bodyDef.position.Set(0, -2.1);
         wallt = world.CreateBody(bodyDef);
         wallt.CreateFixture(fixDef);
         
         fixDef.shape.SetAsBox(2, 100);
         
         bodyDef.position.Set(-2.1, 0);
         walll = world.CreateBody(bodyDef);
         walll.CreateFixture(fixDef);
         
         bodyDef.position.Set(window.innerWidth / 30+2.1, 0);
         wallr = world.CreateBody(bodyDef);
         wallr.CreateFixture(fixDef);

         createBoingy(window.innerWidth / 60-3.5,window.innerHeight / 60-3.5	,7,7);
         
         if(debug) {
        	//setup debug draw
        	 var canvas = document.getElementById("canvas");
        	 canvas.style.display = "block";
        	 canvas.width = window.innerWidth;
        	 canvas.height = window.innerHeight;
             var debugDraw = new b2DebugDraw();
             debugDraw.SetSprite(canvas.getContext("2d"));
             debugDraw.SetDrawScale(30.0);
             debugDraw.SetFillAlpha(0.5);
             debugDraw.SetLineThickness(1.0);
             debugDraw.SetFlags(b2DebugDraw.e_shapeBit | b2DebugDraw.e_jointBit);
             world.SetDebugDraw(debugDraw);
         }
         
         var textureImg = new Image();
         textureImg.onload = function(){
             animate();
         };
         textureImg.src = "crate.jpg";
         


         
      };
      
      
   
   </script>
   
   
</html>