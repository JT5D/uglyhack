<html>
	<head>
		<style type="text/css">
			body {
				margin:0;
				padding:0;
				border:none;
				color:#fff;
				overflow: hidden;
				background-image:url('/img/gray_jean.png');
				background-repeat:repeat;
			}

			.info {
				position: fixed;
				top: 5px;
				right: 5px;
				background: black;
				border-radius: 15px;
				-webkit-box-shadow: 0px 0px 10px rgba(50, 50, 50, 0.75);
				-moz-box-shadow:    0px 0px 10px rgba(50, 50, 50, 0.75);
				box-shadow:         0px 0px 10px rgba(50, 50, 50, 0.75);
				transition: all 1s;
				-moz-transition: all 1s;
				-webkit-transition: all 1s;
				-o-transition: all 1s;
			}
			
			#infoicon {
				width:30px;
				height: 30px;
				text-align: center;
				font-size: 25px;
				cursor: pointer;
				opacity: 1;
			}

			#infobox {
				padding: 15px;
				opacity: 0;
				font-size: 15px;
				width: 225px;
			}

			a {
				color:white;
			}  
			
		</style>
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
	</head>
	<body>
		<canvas id="canvas" width="900" height="500"></canvas>
		<div id="infobox" class="info">
			This is a multi user, multi touch, multi device block building toy. Try playing with it simultaneously on your tablet, phone and desktop.<br/><br/>

			Made by Daniel Pettersson<br/>
			Using Node.js, Express, Socket.io and Box2d<br/><br/>
			Hosted by Nodejitsu<br/><br/>
			Code at <a href="http://code.google.com/p/uglyhack/source/browse/#svn%2Ftrunk%2Fnodebox">Google code</a><br/><br/>
			<a href="http://twitter.com/share" class="twitter-share-button" data-url="http://box.jit.su" data-count="horizontal" data-via="DanielPettersso">Tweet</a><script type="text/javascript" src="https://platform.twitter.com/widgets.js"></script><g:plusone></g:plusone>
		</div>	
		<div id="infoicon" class="info">i</div>	
	</body>
	<script>


	(function() {

		var vendors = ['ms', 'moz', 'webkit', 'o'];
		for(var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
			window.requestAnimationFrame = window[vendors[x]+'RequestAnimationFrame'];
			window.cancelAnimationFrame = 
			window[vendors[x]+'CancelAnimationFrame'] || window[vendors[x]+'CancelRequestAnimationFrame'];
		}
	}());


	window.onload=function() {

		document.getElementById('infoicon').addEventListener("click", function(e) { 
			document.getElementById('infobox').style.opacity = '1'; 
			document.getElementById('infoicon').style.opacity = '0'; 
		});
		document.getElementById('infoicon').addEventListener("mouseover", function(e) { 
			document.getElementById('infobox').style.opacity = '1'; 
			document.getElementById('infoicon').style.opacity = '0'; 
		});

		var headID = document.getElementsByTagName("head")[0];         
		var newScript = document.createElement('script');
		newScript.type = 'text/javascript';
		newScript.src = '/socket.io/socket.io.js';
		newScript.onload = init;
		headID.appendChild(newScript);

		var wood = new Image();
		wood.src = '/img/wood.jpg';

		var drawData;

		function init() {
			var socket = io.connect('http://' + window.location.hostname);
			var canvas = document.getElementById('canvas');
			var scale, scroll;
			doResize();

			var ctx = canvas.getContext("2d");
			ctx.fillStyle="rgba(40, 40, 40, 0.5)";
			ctx.lineWidth = 2;
			ctx.strokeStyle = '#201000';
			var okToRequestAnimationFrame = true;

			var scaleData = function(d) {
				var ret = [];
				for (var i = 0; i < d.length; i ++) {
					ret.push({
						x: d[i].x * scale,
						y: (d[i].y * scale) - scroll,
						r: d[i].r,
						c: d[i].c,
						w: d[i].w * scale,
						h: d[i].h * scale
					});
				}
				return ret;
			};

			socket.on('d', function (data) {
				drawData = data;
				doDraw();
			});

			socket.on('u', function (data) {
				var d;
				for (var i = 0; i < data.length; i ++) {
					d = data[i].split('_');

					drawData[d[3]].x = d[0];
					drawData[d[3]].y = d[1];
					drawData[d[3]].r = d[2];
				}
				if(okToRequestAnimationFrame) {
					doDraw();
				}
			});

			function doDraw() {
				okToRequestAnimationFrame = false;
				requestAnimationFrame(function() {
					ctx.clearRect(0, 0, canvas.width, canvas.height);
					var data = scaleData(drawData);
					drawShadows(data);
					drawShapes(data);
					okToRequestAnimationFrame = true;
				});
			}

			function drawShadows(data) {
				var ww, hh, d;
				for (var i = 0; i < data.length; i ++) {

					d = data[i];
					ww = d.w/2;
					hh = d.h/2;

					ctx.save(); 
					ctx.translate(d.x+ww+5,d.y+hh+5);
					ctx.rotate(d.r);
					ctx.fillRect(-ww,-hh,d.w,d.h);		
					ctx.restore();				
				}
			}

			function drawShapes(data) {
				var ww, hh, d;
				for (var i = 0; i < data.length; i ++) {

					d = data[i];
					ww = d.w/2;
					hh = d.h/2;

					ctx.save(); 
					ctx.translate(d.x+ww,d.y+hh);
					ctx.rotate(d.r);
					ctx.drawImage(wood, 0, 0, d.w, d.h, -ww,-hh, d.w,d.h);
					ctx.beginPath();
					ctx.rect(-ww,-hh,d.w,d.h);		
					ctx.stroke();
					ctx.restore();				
				}
			}
			


			document.addEventListener("mousedown", function(e) {
				document.addEventListener("mousemove", handleMouseMove, true);
				socket.emit('md', {i: 0, x: (e.clientX/scale).toFixed(1), y: ((e.clientY+scroll)/scale).toFixed(1)});
				document.getElementById('infobox').style.opacity = '0'; 
				document.getElementById('infoicon').style.opacity = '1'; 
				e.preventDefault();
			}, true);

			document.addEventListener("mouseup", function(e) {
				document.removeEventListener("mousemove", handleMouseMove, true);
				socket.emit('mu', {i: 0});
				e.preventDefault();
			}, true);

			function handleMouseMove(e) {
				socket.emit('mm', {i: 0, x: (e.clientX/scale).toFixed(1), y: ((e.clientY+scroll)/scale).toFixed(1)});
				e.preventDefault();
			};

			canvas.addEventListener("touchstart", function(e) {
				for(var q = 0; q < e.changedTouches.length; q++) {
					var touch = e.changedTouches[q];
					socket.emit('md', {i: touch.identifier, x: (touch.clientX/scale).toFixed(1), y: ((touch.clientY+scroll)/scale).toFixed(1)});
				}
				document.getElementById('infobox').style.opacity = '0'; 
				document.getElementById('infoicon').style.opacity = '1'; 
				e.preventDefault();
			}, false);

			canvas.addEventListener("touchend", function(e) {
				for(var q = 0; q < e.changedTouches.length; q++) {
					var touch = e.changedTouches[q];
					socket.emit('mu', {i: touch.identifier});
				}
				e.preventDefault();
			}, false);

			canvas.addEventListener("touchmove", function(e) {
				for(var q = 0; q < e.changedTouches.length; q++) {
					var touch = e.changedTouches[q];
					socket.emit('mm', {i: touch.identifier, x: (touch.clientX/scale).toFixed(1), y: ((touch.clientY+scroll)/scale).toFixed(1)});
				}
				e.preventDefault();
			}, false);

			window.addEventListener('resize', doResize, false);
			window.addEventListener('orientationchange', doResize, false);

			function doResize() {
				canvas.width  = window.innerWidth;
		  		canvas.height = window.innerHeight;

				scale = window.innerWidth / 1000.0;
				scroll = (3000 * scale) - canvas.height;
				if(drawData) {
					doDraw();
				}
			}
		}
	};
	</script>
	<script type="text/javascript">
	  var _gaq = _gaq || [];
	  _gaq.push(['_setAccount', 'UA-24008188-1']);
	  _gaq.push(['_trackPageview']);

	  (function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	  })();
	</script>
	<script type="text/javascript">
	  (function() {
	    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
	    po.src = 'https://apis.google.com/js/plusone.js';
	    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
	  })();
	</script>
</html>
