<!DOCTYPE html> 
<html>
	<head> 
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		
		<title>Soundalizer</title> 

		<script type="text/javascript">
			

			function load() {
				
				
			    /* navigator.webkitGetUserMedia('audio', function (stream) {
			    	
			    	
			    	var objectUrl = window.webkitURL.createObjectURL(stream);
			    	var audioTag = document.getElementById('audioTag');
			    	audioTag.src = objectUrl;
			    	
			    	doAudioStuff();
			    	
			    }); */

				var request = new XMLHttpRequest();
			    request.open("GET", "wildecho.wav", true);
			    request.responseType = "arraybuffer";
			    
			    request.onload = function() {
			        doAudioStuff(request.response);
			    }
			    request.send();
			}
			
			function doAudioStuff(assetResponse) {
				var context = new (window.AudioContext || window.webkitAudioContext)();
				var source;
				var processor;
				var analyser;
				var gainNode1;
				var gainNode2;
				var convolver;
				var mainGain;
				var biquadFilter;

				
				var numFreqs = 50;
				var freqWidth = 10;
				var freqDataTags = new Array();

				var assetBuffer = context.createBuffer(assetResponse, false);

				function initAudio(data) {
				    source = context.createBufferSource();

				    if(context.decodeAudioData) {
				        context.decodeAudioData(data, function(buffer) {
				            source.buffer = buffer;
				            createAudio();
				        }, function(e) {
				            console.log(e);
				        });
				    } else {
				        source.buffer = context.createBuffer(data, false /*mixToMono*/);
				        createAudio();
				    }
				}

				function createAudio() {
				    processor = context.createJavaScriptNode(2048 /*bufferSize*/, 1 /*num inputs*/, 1 /*numoutputs*/);
				    processor.onaudioprocess = processAudio;
				    
				    analyser = context.createAnalyser();
				    analyser.minDecibels = -70;

				    convolver = context.createConvolver();
				    convolver.buffer = assetBuffer;

				    gainNode1 = context.createGainNode();
				    gainNode2 = context.createGainNode();
				    mainGain = context.createGainNode();
				    gainNode1.gain.value = 0.5;
				    gainNode2.gain.value = 0.8;
				    mainGain.gain.value = 1.0;

				    biquadFilter = context.createBiquadFilter();
				    biquadFilter.type = biquadFilter.LOWPASS;
				    biquadFilter.frequency = 200;

				    source.connect(gainNode1);
				    gainNode1.connect(mainGain);

				    source.connect(convolver);
				    convolver.connect(gainNode2);
				    gainNode2.connect(mainGain);

				    mainGain.connect(biquadFilter);
				    biquadFilter.connect(context.destination);

				    biquadFilter.connect(analyser);
					analyser.connect(processor);
				    processor.connect(context.destination);

				    source.noteOn(0);
				    setTimeout(disconnect, source.buffer.duration * 1000);
				}

				function disconnect() {
				    source.noteOff(0);
				    source.disconnect(0);
				    processor.disconnect(0);
				    analyser.disconnect(0);
				    gainNode1.disconnect(0);
				    gainNode2.disconnect(0);
				    convolver.disconnect(0);
				    mainGain.disconnect(0);
				    biquadFilter.disconnect(0);
				}

				function processAudio(e) {
				    var freqByteData = new Uint8Array(analyser.frequencyBinCount);
				    analyser.getByteFrequencyData(freqByteData);
				    for(var i = 0; i < numFreqs; i++) {
				    	var f = i*freqWidth;
				    	var divHeight = ((freqByteData[f]/255.0)*100.0)+1;
	     				freqDataTags[i].style.height = divHeight + '%';

	     				var col = 255-freqByteData[f];
	     				freqDataTags[i].style.background = 
	     					'rgb(' + col + ',' + col + ',' + col + ')';
					}
				}

				function dropEvent(evt) {
				    evt.stopPropagation();
				    evt.preventDefault();

				    var reader = new FileReader();
				    reader.onload = function(e) {
				    	initAudio(e.target.result);	
				    }
				    reader.readAsArrayBuffer(evt.dataTransfer.files[0]);		    
				    
				}

				function dragOver(evt) {
				    evt.stopPropagation();
				    evt.preventDefault();
				    return false;
				}

				var dropArea = document.getElementById('dropArea');
				dropArea.addEventListener('drop', dropEvent, false);
				dropArea.addEventListener('dragover', dragOver, false);
				
				
		    	for(var i = 0; i < numFreqs; i++) {
					var dd = (100.0 / numFreqs) * i;

		    		var el = document.createElement('div');
		     		el.style.background = 'rgb(255,255,255)';
		     		el.style.width = '2%';
		     		el.style.height = '1px';
		     		el.style.position = 'absolute';
		     		el.style.left =  dd + '%';
     				el.style.bottom =  '0px';
		     		el.innerHTML = '&nbsp;';
		     		dropArea.appendChild(el);
		     		freqDataTags[i] = el;
		    	}

				var svgElem = document.getElementById('svgelem');
		    	for(var a = 0; a <= 100; a+=5) {
		    		var el = document.createElementNS("http://www.w3.org/2000/svg","line");
		    		el.setAttribute('x1', 0);
		    		el.setAttribute('y1', a + '%');
		    		el.setAttribute('x2', a + '%');
		    		el.setAttribute('y2', '100%');
		    		el.style.stroke = 'red';
		    		el.style['stroke-width'] = 2;
		    		svgElem.appendChild(el);
		    	}
			} 

	    </script>

		<style> 
			body {
				overflow: hidden;
				height: 100%;
			}

			div.fullscreen{
			    display:block;

			    position:absolute;
			    top:0;
			    left:0;
			    
			    width:100%;
			    height:100%;
			}
		</style>

	</head>
	
	<body onload="load()">
		<div id="dropArea" class="fullscreen">
			<svg id="svgelem" class="fullscreen" xmlns="http://www.w3.org/2000/svg">
			</svg>
		</div>
	</body>
	
</html>